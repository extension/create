<?php
// $Id$
class NotificationsSubscribeTestCase extends DrupalWebTestCase {
  protected $profile = 'testing';

  /**
   * Implementation of getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => t('Notifications subscribe'),
      'description' => t('Establish a subscription.'),
      'group' => t('Notifications'),
    );
  }

  /**
   * Implementation of setUp().
   */
  function setUp() {
    parent::setUp(array(
      'trigger',
      'messaging',
      'notifications',
      'notifications_content',
      'notifications_user',
    ));

    // Create and login user
    $admin_user = $this->drupalCreateUser(array(
      'access administration pages',
      'administer site configuration',
      'administer nodes',
      'administer content types',
      'administer notifications',
      'maintain own subscriptions',
      'subscribe to content',
      'create subscriptions',
    ));
    $this->drupalLogin($admin_user);

    // Create a content type to subscribe to.
    $edit = array('name' => 'Post', 'type' => 'post');
    $this->drupalPost('admin/structure/types/add', $edit, t('Save content type'));
  }

  function testSubscribe() {
    // Create the subscription
    $edit = array('subscription_fields[0]' => 'post');
    $this->drupalPost('notifications/subscribe/content_type', $edit, t('Create subscription'));
    $this->assertRaw(t('The subscription has been created.'));

    // Attempt to view the subscription
    $this->drupalGet('user/2/notifications');
    $this->assertRaw(t('You have %number active subscriptions.', array('%number' => 1)));
    // You have 1 active subscriptions.

    // Attempt to view the specifics
    $this->drupalGet('user/2/notifications/content_type');
    $this->assertRaw(t('Post posts'));

    // Verify that it also on the admin listing.
    $this->drupalGet('admin/notifications');
    $this->assertRaw(t('Post posts'));
  }
}

