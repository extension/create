<?php
/**
 * eximport - content seed from feed.
 *
 * @package eximport 
 * @version 0.1
 * @author James E. Robinson, III <james.robinson@extension.org>
 * @copyright North Carolina State University 2010
 */

// Bootstrap Drupal - if including in standalone script
// require 'includes/bootstrap.inc';
// drupal_bootstrap(DRUPAL_BOOTSTRAP_FULL);

/**
 *
 * Import Plan
 *
 * 1. export all revisions of all articles from MW
 *    a. create XML files with about 250 articles in each
 *    b. Format as valid Atom 1.0 feed
 *    c. will have approx 1200 files after export
 *
 * 2. import revisions
 *    a. use DrupalBot as the user for publishing events
 *    b. mark all published revisions as such
 *    c. when import complete, mark all unpublished articles as draft
 *    d. import 'news' articles as content-type news, all others as articles
 *
 * 3. import images? Nope
 *
 * 4. rewrite URLs
 *    a. rewrite img src's
 *    b. rewrite wiki href's
 *
 * 5. article metadata
 *    a. ???
 */

// TODO handle publishing flag
// TODO metadata?

// confirm access to node methods
module_load_include('inc', 'node', 'node.pages', 'path', 'filter'); 

/**
 * hook_help entry-point function.
 * Let folks know what this is if they are clueless.
 *
 * @param string $path request.uri path.
 * @param array $arg pieces of uri split by '/'.
 * @return string HTML for module help.
 * @see hook_help
 */
function eximport_help($path, $arg) {
  $output = '';
  switch ($path) {
    case "admin/help#eximport":
      $output = '<p>'
              . t("To assist in the import of MediaWiki content.")
              . '</p>';
    break;
  }
  return $output;
}

/**
 * hook_permission entry-point function.
 * Add an eximport specific permission, for giggles.
 *
 * @return n/a.
 * @see hook_permission
 */
function eximport_permission() {
  return array(
    'administer import' =>  array(
      'title' => t('Administer eX Import'),
      'description' => t('Use caution.'),
    ),
  );
}

/**
 * hook_menu entry-point function.
 * Add an eximport specific routes.
 *
 * @return array $items Array of routes for this module.
 * @see hook_menu
 */
function eximport_menu() {
  $items = array();
  
  $items['admin/config/extension/import'] = array(
    'title' => 'Import Content',
    'description' => 'Tools for importing wiki data.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('eximport_admin_form'),
    'access arguments' => array('administer import')
    );
    
  return $items;
}

/**
 * Define the admin form.
 *
 * @param array $form form array.
 * @param array &$form_state Reference to array with the current form state.
 * @return array Form array.
 * @see forms_api_reference
 */
function eximport_admin_form($form, &$form_state) {

  $form['filename'] = array(
    '#type' => 'textfield',
    '#title' => t('File to import'),
    '#default_value' => 'import.xml',
    '#size' => 40,
    '#maxlength' => 80,
    '#description' => t("Filename of default import file."),
    '#required' => TRUE,
  );
  
  $form['submit'] = array('#type' => 'submit', '#value' => t('Import'));
  
  return $form;
}

/**
 * Validate admin form input.
 *
 * @param array $form form array.
 * @param array &$form_state Reference to array with the current form state.
 * @return n/a
 * @see _form_validate
 */
function eximport_admin_form_validate($form, &$form_state) {
  $filename = $form_state['values']['filename'];
  if ( ! preg_match('/\.(xml|atom)$/i', $filename)) {
    form_set_error('', t('A valid filename is required.'));
  } elseif ( ! eximport_verify_filename($filename) ) {
    form_set_error('', t('File must exist in import directory.'));
  }
}

/**
 * Given filename, return location of file.
 *
 * @param string $filename Input filename.
 * @return string Full path to file.
 */
function eximport_get_fullpath($filename) {
  $path_parts = array(DRUPAL_ROOT, 'import', $filename);
  return implode(DIRECTORY_SEPARATOR, $path_parts);
}

/**
 * Given filename, verify exists in file system.
 *
 * @param string $filename Input filename.
 * @return boolean True if file exists, FALSE otherwise.
 * @see _form_validate
 */
function eximport_verify_filename($filename) {
  $target = eximport_get_fullpath($filename);
  return file_exists($target);
}

/**
 * Process form after submission.
 *
 * @param array $form form array.
 * @param array &$form_state Reference to array with the current form state.
 * @return n/a
 * @see form_execute_handlers
 */
function eximport_admin_form_submit($form, &$form_state) {
  $filename = $form_state['values']['filename'];
  
  list($total, $added, $errors) = eximport_import_from_file($filename);
  
  if ($errors) {
    drupal_set_message(t('Import failed: ' 
                         . $errors . ' errors out of ' 
                         . $total . ' revisions.'), 'error');
  } else {
    drupal_set_message(t('Import successful. ' 
                         . $added . ' out of ' 
                         . $total . ' revisions imported.'));
  }

  return;
}

/**
 * Create a Drupal node and revision from input.
 *
 * @param object $entry Object with data for new node.
 * @return boolean TRUE if successful, FALSE otherwise
 * @see node_save
 */
function eximport_node_create($entry) {
  $rc = FALSE;
  $nid = 0;
  $new = FALSE;
  
  // First, try to see if we've imported a node with the same link
  $path = path_load(array('alias' => $entry->old_link));
  if ($path) {
    $nid = $path['source'];
  }
  unset($path);
  
  // Construct the new node object.
  
  if ($nid) {
    // reset entity_load cache - be sure we have the latest version
    $node = node_load($nid, NULL, TRUE);
    $node->revision = '1';
  } else {
    $new = TRUE;
    $node = new stdClass();
    $node->type = $entry->type;
    node_object_prepare($node);
    $node->language = LANGUAGE_NONE;
    $node->created = $entry->created;
  }
  
  $node->uid = $entry->uid;
  $node->title = $entry->title;
  
  $node->changed = $entry->created;
  
  $node->body = $entry->body;
  
  $node->field_tags = $entry->field_tags;
  node_save($node);
  
  $nid = $node->nid;
  
  if ($nid and $new) {
    eximport_save_old_link($nid, $entry->old_link);
    $rc = TRUE;
  } elseif ($nid) {
    $rc = TRUE;
  }
  
  dvm($node);
  unset($node);
  unset($entry);
  
  return $rc;
}

/**
 * Create a Drupal node and revision from input.
 *
 * @param integer $nid Node ID.
 * @param string $old_link URL for old article location.
 * @see path_inc
 */
function eximport_save_old_link($nid, $old_link) {
  $path = array('alias' => $old_link, 'source' => "$nid");
  
  $exists = path_load("$nid");
  if ($exists) {
    $path['pid'] = $exists['pid'];
  }
  
  path_save($path);
  return;
}

/**
 * Create a new content entry object from XML input.
 *
 * @param object $atom_entry SimpleXML Atom entry object.
 * @return object Generic content entry object
 */
function eximport_entry_create($atom_entry) {
  $entry = new stdClass();
  
  // default to article content-type
  $entry->type = 'article';
    
  // create our tag array
  $categories = array();
  foreach ($atom_entry->category as $cat) {
    if ($cat['term'] == 'news') {
      // if it is news, change content-type
      $entry->type = 'news';
    }
    $cat_entry = array('vid' => '1',
                       'tid' => 'autocreate',
                       'name' => (string)$cat['term']);
    $categories[] = $cat_entry;
  }
  
  $entry->field_tags = array(LANGUAGE_NONE => $categories);
  
  // author
  $entry->uid = eximport_find_author((string)$atom_entry->author->name[0]);
  
  // duh
  $entry->title = (string)$atom_entry->title;
  
  // create our body array
  $teaser = eximport_get_teaser($atom_entry->content);
  $body = (string)$atom_entry->content;
  $entry->body = array(LANGUAGE_NONE =>
                  array(0 =>
                    array('summary' => $teaser,
                          'value' => $body,
                          'format' => filter_default_format()
                          )));
  
  $entry->created = strtotime($atom_entry->updated);
  
  $entry->old_link = (string)$atom_entry->link['href'];
  
  return $entry;
}

/**
 * Some existing eXtension articles have a teaser/summary embeded.
 * Pull out teaser from HTML to enable us to put in new node.
 *
 * @param string $content HTML content for a 'news' article.
 * @return string HTML for teaser content only
 */
function eximport_get_teaser($content) {
  $summary = "";
  if ( ! empty($content)) {
    $find_sum = '#<div\ id="summary"\ class="printme\ toc">(.*?)</div>#m';
  
    $matches = array();
    $found = preg_match($find_sum, $content, $matches);
  
    if ($found) {
      $summary = $matches[1];
    }
  }
  
  return $summary;
}

/**
 * Find Drupal uid given eXtensionID.
 *
 * @param string $exid eXtension ID string.
 * @return integer Drupal uid if exists, 0 otherwise
 * @see user_load_multiple
 */
function eximport_find_author($exid) {
  $id = 0;
  $account = user_load_by_name($exid);

  if ($account) {
    $id = $account->uid;
  }
  
  return $id;
}

/**
 * Load content from Atom formatted XML file.
 *
 * @param string $filename Input filename with full path.
 * @return array Total number, number added, number errors.
 * @see SimpleXML
 */
function eximport_import_from_file($filename) {
  $added = 0;
  $errors = 0;
  
  $target = eximport_get_fullpath($filename);
  
  $xml = simplexml_load_file($target);
  
  $total = count($xml->entry);
  
  for ($i=0; $i < $total; $i++) {
    $atom_entry = $xml->entry[$i];
    // use an intermediate object to reduce complexity and aid debugging
    $entry = eximport_entry_create($atom_entry);
    $nid = eximport_node_create($entry);
    if ($nid) {
      $added++;
    } else {
      $errors++;
    }
  }
  
  return array($total, $added, $errors);
}